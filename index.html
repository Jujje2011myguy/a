<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Enhanced Tower Defense</title>
<style>
  :root{--panel:rgba(255,255,255,0.06);--accent:#4aa3ff;--good:#7ee787;--bad:#ff6b6b}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071226,#0b1a2b);color:#e6eef8}
  /* move everything down a bit */
  #wrap{margin-top:48px;width:1000px;max-width:98vw;margin-left:auto;margin-right:auto;display:flex;gap:18px;padding:18px;box-sizing:border-box}
  #game{background:linear-gradient(180deg,#85c1ff10,#ffffff02);border-radius:10px;padding:10px;box-shadow:0 6px 30px rgba(0,0,0,0.6);display:flex;gap:12px}
  canvas{background:linear-gradient(180deg,#cfefff,#eaf8ff);border-radius:6px;display:block}
  #left{width:820px}
  #right{width:160px;display:flex;flex-direction:column;gap:10px}
  .panel{background:var(--panel);padding:10px;border-radius:8px}
  .hud{display:flex;gap:8px;justify-content:space-between;margin-bottom:8px}
  .stat{padding:8px;border-radius:6px;background:rgba(0,0,0,0.18);min-width:80px;text-align:center}
  .controls{display:flex;flex-direction:column;gap:8px}
  .tower-btn{padding:8px;border-radius:6px;cursor:pointer;border:1px solid rgba(255,255,255,0.06);display:flex;gap:8px;align-items:center}
  .tower-btn.selected{box-shadow:0 0 0 3px rgba(74,163,255,0.12);border-color:rgba(74,163,255,0.25)}
  .small{font-size:13px;opacity:0.9}
  #message{text-align:center;margin-top:8px;color:var(--accent);font-weight:600}
  .power{display:flex;gap:6px;flex-wrap:wrap}
  .pill{padding:6px 8px;border-radius:6px;background:#08122655;font-size:13px}
  footer{margin-top:10px;font-size:12px;opacity:0.7;text-align:center}
  canvas{-webkit-user-select:none;-webkit-touch-callout:none}
  .btn{background:linear-gradient(180deg,#377fd6,#2a5fa8);border:none;color:white;padding:8px;border-radius:6px;cursor:pointer}
  .btn.secondary{background:#444444}
  input[type=number]{width:64px;padding:6px;border-radius:6px;border:1px solid #333;background:#031022;color:#fff}
</style>
</head>
<body>
<div id="wrap">
  <div id="left">
    <div class="panel">
      <div class="hud">
        <div class="stat">üí∞ <div id="gold">150</div></div>
        <div class="stat">‚ù§Ô∏è <div id="lives">20</div></div>
        <div class="stat">üåä <div id="wave">0</div></div>
        <div class="stat">üèÜ <div id="score">0</div></div>
      </div>
      <canvas id="c" width="800" height="600"></canvas>
      <div id="message" class="small">Press SPACE to start next wave ‚Äî Click to place a tower (cost shown)</div>
    </div>
  </div>

  <div id="right">
    <div class="panel controls">
      <div style="font-weight:700;margin-bottom:6px">Towers (press 1-6)</div>
      <div id="towerList"></div>

      <div style="margin-top:8px;font-weight:700">Power-ups</div>
      <div class="power small" id="powerLegend">
        <div class="pill">Gold Boost</div>
        <div class="pill">Speed Boost</div>
        <div class="pill">Shield</div>
        <div class="pill">Nuke</div>
      </div>

      <div style="margin-top:8px;font-weight:700">Controls</div>
      <div class="small">1-6: Select tower ‚Ä¢ LeftClick: Place ‚Ä¢ RightClick: Upgrade ‚Ä¢ SPACE: Start wave</div>

      <div style="margin-top:10px;display:flex;gap:6px;align-items:center">
        <button class="btn" id="sendWavesBtn">Send Waves</button>
        <input id="sendCount" type="number" min="1" value="1" />
      </div>

      <div style="margin-top:8px;display:flex;gap:6px">
        <button class="btn secondary" id="collectAll">Collect All Power-ups</button>
        <button class="btn" id="fastForward">Fast Forward</button>
      </div>

    </div>

    <div class="panel small">
      <div style="font-weight:700">Selected</div>
      <div id="selectedInfo">Basic Tower</div>
    </div>

    <div class="panel small">
      <div style="font-weight:700">Tips</div>
      <div>- Towers auto-fire nearest enemy in range.</div>
      <div>- Click power-ups to collect or use Collect All.</div>
      <div>- Right-click tower to upgrade it (cost grows).</div>
    </div>
  </div>
</div>

<footer class="small">Built for GitHub Pages ‚Äî client-side only</footer>

<script>
/* ========= Game constants and state ========= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let gold = 150;
let lives = 20;
let wave = 0;
let score = 0;
let playing = true;
let waveActive = false;
let selectedTowerType = 'basic';

const towerTypes = {
  basic:  { id:'basic',  name:'Basic',  cost:50,  range:120, fireRate:40, dmg:6,  color:'#4A90E2' },
  sniper: { id:'sniper', name:'Sniper', cost:120, range:260, fireRate:90, dmg:30, color:'#8A54FF' },
  rapid:  { id:'rapid',  name:'Rapid',  cost:80,  range:100, fireRate:12, dmg:3,  color:'#FF9F43' },
  heavy:  { id:'heavy',  name:'Heavy',  cost:180, range:90,  fireRate:80, dmg:60, color:'#2B6BA3' },
  poison: { id:'poison', name:'Poison', cost:140, range:110, fireRate:36, dmg:4,  color:'#4CAF50' },
  slow:   { id:'slow',   name:'Frost',  cost:130, range:110, fireRate:50, dmg:2,  color:'#39A0ED' }
};

let towers = [];
let enemies = [];
let projectiles = [];
let particles = [];
let powerups = [];
let timeScale = 1; // fast forward multiplier

const ui = {
  goldEl: document.getElementById('gold'),
  livesEl: document.getElementById('lives'),
  waveEl: document.getElementById('wave'),
  scoreEl: document.getElementById('score'),
  selectedInfo: document.getElementById('selectedInfo'),
  towerList: document.getElementById('towerList')
};

/* ===== Path definition ===== */
const path = [
  {x:-40,y:150}, {x:160,y:150}, {x:160,y:320}, {x:420,y:320}, {x:420,y:260}, {x:700,y:260}, {x:900,y:260}
];

/* ===== Utility ===== */
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);} 
function rand(min,max){return Math.random()*(max-min)+min;} 
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

/* ===== Enemy class ===== */
class Enemy{
  constructor(type){
    this.type = type;
    this.maxHp = type.hp;
    this.hp = type.hp;
    this.speed = type.speed;
    this.color = type.color;
    this.radius = type.radius || 12;
    this.pathIndex = 0;
    this.x = path[0].x;
    this.y = path[0].y;
    this.reached = false;
    this.slowTimer = 0;
    this.dot = 0;
    this.dotTimer = 0;
  }
  update(dt){
    if(this.slowTimer > 0){
      this.slowTimer -= dt;
      if(this.slowTimer < 0) this.slowTimer = 0;
    }
    const sp = (this.slowTimer > 0) ? this.speed * 0.45 : this.speed;
    if(this.pathIndex < path.length - 1){
      const target = path[this.pathIndex + 1];
      const dx = target.x - this.x;
      const dy = target.y - this.y;
      const d = Math.hypot(dx,dy);
      if(d < sp * dt){
        this.pathIndex++;
      } else {
        this.x += dx / d * sp * dt;
        this.y += dy / d * sp * dt;
      }
    } else {
      this.reached = true;
    }
  }
  draw(){
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    const w = this.radius * 2;
    ctx.fillStyle = '#000000aa';
    ctx.fillRect(this.x - this.radius, this.y - this.radius - 8, w, 4);
    ctx.fillStyle = '#7ee787';
    ctx.fillRect(this.x - this.radius, this.y - this.radius - 8, w * (this.hp / this.maxHp), 4);
    ctx.strokeStyle = '#00000055';
    ctx.strokeRect(this.x - this.radius, this.y - this.radius - 8, w, 4);
  }
}

/* ===== Tower class ===== */
class Tower{
  constructor(x,y,type){
    this.x = x;
    this.y = y;
    this.baseType = type;
    this.type = JSON.parse(JSON.stringify(type));
    this.level = 1;
    this.fireCooldown = 0;
  }
  upgrade(){
    const cost = Math.floor(this.baseType.cost * (1 + this.level * 0.6));
    if(gold >= cost){
      gold -= cost;
      this.level++;
      this.type.dmg = Math.round(this.type.dmg * 1.6);
      this.type.range = Math.round(this.type.range * 1.05);
      this.type.fireRate = Math.max(4, Math.floor(this.type.fireRate * 0.85));
      return true;
    }
    return false;
  }
  update(dt){
    this.fireCooldown -= dt * 60 * timeScale;
    if(this.fireCooldown <= 0){
      let target = null;
      let bestProgress = -1;
      for(let e of enemies){
        const d = Math.hypot(e.x - this.x, e.y - this.y);
        if(d <= this.type.range){
          let progress = e.pathIndex + (Math.hypot(e.x - path[e.pathIndex].x, e.y - path[e.pathIndex].y) / 200);
          if(progress > bestProgress){
            bestProgress = progress;
            target = e;
          }
        }
      }
      if(target){
        this.fireAt(target);
        this.fireCooldown = this.type.fireRate;
      }
    }
  }
  fireAt(target){
    if(this.baseType.id === 'poison'){
      projectiles.push(new PoisonProjectile(this.x, this.y, target, this.type.dmg));
    } else if(this.baseType.id === 'slow'){
      projectiles.push(new SlowProjectile(this.x, this.y, target, this.type.dmg));
    } else {
      projectiles.push(new Projectile(this.x, this.y, target, this.type.dmg));
    }
  }
  draw(){
    ctx.strokeStyle = 'rgba(70,140,200,0.12)';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.type.range, 0, Math.PI * 2);
    ctx.stroke();
    ctx.fillStyle = this.type.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, 14, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#0008';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Lv' + this.level, this.x, this.y + 4);
  }
}

/* ===== Projectiles ===== */
class Projectile{
  constructor(x,y,target,dmg){
    this.x = x; this.y = y; this.target = target; this.speed = 8; this.dmg = dmg; this.radius = 4; this.color = '#ffd93d';
  }
  update(dt){
    if(!this.target || this.target.reached) return false;
    const dx = this.target.x - this.x;
    const dy = this.target.y - this.y;
    const d = Math.hypot(dx,dy);
    if(d < this.speed * dt){
      this.target.hp -= this.dmg;
      if(this.target.hp <= 0) killEnemy(this.target);
      return false;
    }
    this.x += dx / d * this.speed * dt;
    this.y += dy / d * this.speed * dt;
    return true;
  }
  draw(){
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}

class PoisonProjectile extends Projectile{
  constructor(x,y,target,dmg){ super(x,y,target,dmg); this.color = '#8bc34a'; }
  update(dt){
    if(!this.target || this.target.reached) return false;
    const dx = this.target.x - this.x, dy = this.target.y - this.y;
    const d = Math.hypot(dx,dy);
    if(d < this.speed * dt){
      this.target.hp -= this.dmg;
      this.target.dot = (this.target.dot || 0) + 6;
      this.target.dotTimer = 6;
      if(this.target.hp <= 0) killEnemy(this.target);
      return false;
    }
    this.x += dx / d * this.speed * dt;
    this.y += dy / d * this.speed * dt;
    return true;
  }
}

class SlowProjectile extends Projectile{
  constructor(x,y,target,dmg){ super(x,y,target,dmg); this.color = '#39A0ED'; }
  update(dt){
    if(!this.target || this.target.reached) return false;
    const dx = this.target.x - this.x, dy = this.target.y - this.y;
    const d = Math.hypot(dx,dy);
    if(d < this.speed * dt){
      this.target.hp -= this.dmg;
      this.target.slowTimer = Math.max(this.target.slowTimer || 0, 120);
      if(this.target.hp <= 0) killEnemy(this.target);
      return false;
    }
    this.x += dx / d * this.speed * dt;
    this.y += dy / d * this.speed * dt;
    return true;
  }
}

/* ===== Particles ===== */
class Particle{
  constructor(x,y,color){ this.x = x; this.y = y; this.vx = rand(-2,2); this.vy = rand(-2,2); this.life = rand(30,70); this.color = color; this.r = rand(1,3); }
  update(){ this.x += this.vx; this.y += this.vy; this.vy += 0.06; this.life--; }
  draw(){ ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill(); }
}

/* ===== PowerUp ===== */
class PowerUp{
  constructor(x,y,kind){ this.x = x; this.y = y; this.kind = kind; this.radius = 12; this.ttl = 12*60; }
  update(){ this.ttl--; }
  draw(){
    ctx.fillStyle = '#ffffffdd';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#222';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    const label = {gold:'G', speed:'S', shield:'H', nuke:'N'}[this.kind] || '?';
    ctx.fillText(label, this.x, this.y + 4);
  }
}

/* ===== Enemy presets & spawn ===== */
const enemyPresets = {
  grunt:  { hp:30,  speed:1.2, color:'#FF6B6B', radius:10, score:8 },
  shield: { hp:70,  speed:0.75, color:'#ffd86b', radius:14, score:20 },
  fast:   { hp:18,  speed:1.9, color:'#7ee787', radius:9,  score:10 },
  boss:   { hp:800, speed:0.45, color:'#8a54ff', radius:26, score:300 }
};

function spawnWave(){
  wave++;
  ui.waveEl.textContent = wave;
  waveActive = true;
  const count = 5 + Math.floor(wave * 2.5);
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      let t = enemyPresets.grunt;
      if(wave > 6 && Math.random() < 0.25) t = enemyPresets.shield;
      else if(wave > 3 && Math.random() < 0.25) t = enemyPresets.fast;
      enemies.push(new Enemy({...t}));
    }, i * 500 / timeScale);
  }
  if(wave % 7 === 0){
    setTimeout(()=> enemies.push(new Enemy({...enemyPresets.boss})), count * 500 / timeScale + 1200);
  }
}

/* multi-wave sender */
function sendMultipleWaves(n){
  n = Math.max(1, Math.floor(n));
  let delay = 0;
  for(let i=0;i<n;i++){
    setTimeout(()=> spawnWave(), delay);
    delay += 4000 / timeScale;
  }
}

/* kill enemy */
function killEnemy(e){
  for(let i=0;i<16;i++) particles.push(new Particle(e.x, e.y, e.color));
  let base = Math.max(6, Math.floor(e.maxHp / 10));
  gold += base;
  score += (e.type && e.type.score) ? e.type.score : 10;
  if(Math.random() < 0.14){
    const kinds = ['gold','speed','shield','nuke'];
    const kind = kinds[Math.floor(Math.random() * kinds.length)];
    powerups.push(new PowerUp(e.x + rand(-12,12), e.y + rand(-12,12), kind));
  }
  const idx = enemies.indexOf(e);
  if(idx >= 0) enemies.splice(idx,1);
}

/* collect all powerups */
function collectAllPowerups(){
  for(let i = powerups.length - 1; i >= 0; i--){
    applyPowerup(powerups[i].kind);
    powerups.splice(i,1);
  }
  flashMessage('Collected all power-ups');
}

/* apply powerup */
function applyPowerup(kind){
  flashMessage('Picked: ' + kind);
  if(kind === 'gold'){
    gold += 120;
  } else if(kind === 'speed'){
    for(let t of towers) t.type.fireRate = Math.max(3, Math.floor(t.type.fireRate * 0.6));
    setTimeout(()=> rebuildTowerRates(), 8000);
  } else if(kind === 'shield'){
    lives += 5;
  } else if(kind === 'nuke'){
    for(let i=enemies.length-1;i>=0;i--) killEnemy(enemies[i]);
  }
}

function rebuildTowerRates(){
  for(let t of towers){
    const base = towerTypes[t.baseType.id];
    if(base) t.type.fireRate = base.fireRate;
  }
}

/* ===== Update / Draw loops ===== */
let last = performance.now();
function update(){
  const now = performance.now();
  let dt = (now - last) / 16.6667; // ~60fps units
  dt *= timeScale;
  last = now;
  if(!playing) return;

  for(let t of towers) t.update(dt);

  for(let i = projectiles.length - 1; i >= 0; i--){
    if(!projectiles[i].update(dt)) projectiles.splice(i,1);
  }

  for(let i = enemies.length - 1; i >= 0; i--){
    const e = enemies[i];
    if(e.dotTimer && e.dotTimer > 0){
      e.dotTimer -= dt / 1;
      e.hp -= (e.dot || 0) * (dt / 10);
      if(e.dotTimer <= 0){ e.dot = 0; e.dotTimer = 0; }
    }
    e.update(dt);
    if(e.reached){
      lives -= 1;
      particles.push(new Particle(e.x, e.y, '#ff6b6b'));
      enemies.splice(i,1);
      if(lives <= 0) playing = false;
    } else if(e.hp <= 0){
      killEnemy(e);
    }
  }

  for(let i = particles.length - 1; i >= 0; i--){
    particles[i].update();
    if(particles[i].life <= 0) particles.splice(i,1);
  }

  for(let i = powerups.length - 1; i >= 0; i--){
    powerups[i].update();
    if(powerups[i].ttl <= 0) powerups.splice(i,1);
  }

  if(waveActive && enemies.length === 0 && projectiles.length === 0){
    waveActive = false;
    gold += 60 + Math.floor(wave * 8);
  }

  ui.goldEl.textContent = gold;
  ui.livesEl.textContent = lives;
  ui.scoreEl.textContent = score;
}

/* ===== Drawing ===== */
function draw(){
  ctx.clearRect(0,0,W,H);

  // draw path thick
  ctx.lineWidth = 36;
  ctx.strokeStyle = '#b88955';
  ctx.beginPath();
  ctx.moveTo(path[0].x, path[0].y);
  for(let p of path) ctx.lineTo(p.x, p.y);
  ctx.stroke();

  // draw path edges
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#673f1f33';
  ctx.beginPath();
  ctx.moveTo(path[0].x, path[0].y);
  for(let p of path) ctx.lineTo(p.x, p.y);
  ctx.stroke();

  // draw towers
  for(let t of towers) t.draw();

  // draw projectiles
  for(let p of projectiles) p.draw();

  // draw enemies
  enemies.sort((a,b) => a.pathIndex - b.pathIndex);
  for(let e of enemies) e.draw();

  // draw particles
  for(let p of particles) p.draw();

  // draw powerups
  for(let p of powerups) p.draw();

  if(!playing){
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#ff6b6b';
    ctx.font = '48px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER', W/2, H/2 - 10);
    ctx.fillStyle = '#fff';
    ctx.font = '18px sans-serif';
    ctx.fillText('Press F5 to try again', W/2, H/2 + 24);
  }
}

/* ===== Input handling ===== */
let mouse = { x:0, y:0 };
canvas.addEventListener('mousemove', (e) => {
  const r = canvas.getBoundingClientRect();
  mouse.x = (e.clientX - r.left) * (canvas.width / r.width);
  mouse.y = (e.clientY - r.top) * (canvas.height / r.height);
});
canvas.addEventListener('mousedown', (e) => {
  if(e.button === 0){ onLeftClick(mouse.x, mouse.y); }
});
canvas.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  const r = canvas.getBoundingClientRect();
  const mx = (e.clientX - r.left) * (canvas.width / r.width);
  const my = (e.clientY - r.top) * (canvas.height / r.height);
  for(let t of towers){
    if(Math.hypot(t.x - mx, t.y - my) < 20){
      const ok = t.upgrade();
      if(ok) flashMessage('Upgraded!');
      else flashMessage('Not enough gold');
      break;
    }
  }
  return false;
});
canvas.addEventListener('click', (ev) => {
  const r = canvas.getBoundingClientRect();
  const mx = (ev.clientX - r.left) * (canvas.width / r.width);
  const my = (ev.clientY - r.top) * (canvas.height / r.height);
  for(let i = powerups.length - 1; i >= 0; i--){
    const p = powerups[i];
    if(Math.hypot(p.x - mx, p.y - my) <= p.radius + 4){
      applyPowerup(p.kind);
      powerups.splice(i,1);
      break;
    }
  }
});

function onLeftClick(x,y){
  const type = towerTypes[selectedTowerType];
  if(gold < type.cost){ flashMessage('Not enough gold'); return; }
  // don't place too close to path
  let tooClose = false;
  for(let i=0;i<path.length-1;i++){
    const a = path[i], b = path[i+1];
    const segLen = Math.hypot(b.x - a.x, b.y - a.y);
    if(segLen === 0) continue;
    const t = ((x - a.x)*(b.x - a.x) + (y - a.y)*(b.y - a.y)) / (segLen*segLen);
    const tt = clamp(t,0,1);
    const projx = a.x + tt*(b.x - a.x), projy = a.y + tt*(b.y - a.y);
    if(Math.hypot(x - projx, y - projy) < 24){ tooClose = true; break; }
  }
  if(tooClose){ flashMessage('Too close to path'); return; }
  gold -= type.cost;
  towers.push(new Tower(x,y, type));
}

/* collect all button */
document.getElementById('collectAll').addEventListener('click', () => collectAllPowerups());

/* send waves UI */
document.getElementById('sendWavesBtn').addEventListener('click', () => {
  const n = parseInt(document.getElementById('sendCount').value || 1);
  sendMultipleWaves(n);
});

document.getElementById('fastForward').addEventListener('click', () => {
  timeScale = timeScale === 1 ? 2 : 1;
  flashMessage('Time x' + timeScale);
});

/* ===== small helpers ===== */
let msgTimeout = 0;
function flashMessage(text){
  const el = document.getElementById('message');
  el.textContent = text;
  clearTimeout(msgTimeout);
  msgTimeout = setTimeout(()=>{ el.textContent = 'Press SPACE to start next wave ‚Äî Click to place a tower (cost shown)'; }, 2200);
}

/* ===== keyboard ===== */
window.addEventListener('keydown', (e) => {
  if(e.code === 'Space'){
    if(!waveActive) spawnWave();
  } else if(['Digit1','Digit2','Digit3','Digit4','Digit5','Digit6'].includes(e.code)){
    const idx = parseInt(e.code.slice(-1),10) - 1;
    const keys = Object.keys(towerTypes);
    if(keys[idx]){ selectedTowerType = keys[idx]; updateSelectedUI(); }
  }
});

/* ===== UI build for towers ===== */
function updateSelectedUI(){
  ui.selectedInfo.innerHTML = `${towerTypes[selectedTowerType].name} ‚Äî Cost: ${towerTypes[selectedTowerType].cost}`;
  const buttons = document.querySelectorAll('.tower-btn');
  buttons.forEach(b => b.classList.toggle('selected', b.dataset.type === selectedTowerType));
}

function buildTowerList(){
  ui.towerList.innerHTML = '';
  let i = 1;
  for(const k in towerTypes){
    const t = towerTypes[k];
    const btn = document.createElement('div');
    btn.className = 'tower-btn';
    btn.dataset.type = k;
    if(k === selectedTowerType) btn.classList.add('selected');
    btn.innerHTML = `<div style="width:18px;height:18px;border-radius:4px;background:${t.color}"></div>
                     <div style="flex:1">
                       <div style="font-weight:700">${i}. ${t.name}</div>
                       <div class="small">cost:${t.cost} dmg:${t.dmg} rate:${t.fireRate}</div>
                     </div>`;
    btn.addEventListener('click', ()=>{ selectedTowerType = k; updateSelectedUI(); });
    ui.towerList.appendChild(btn);
    i++;
  }
}
buildTowerList();
updateSelectedUI();

/* ===== main loop ===== */
function loop(){ update(); draw(); requestAnimationFrame(loop); }
last = performance.now(); loop();

/* ===== ghost tower overlay (drawn after draw) ===== */
(function wrapDraw(){
  const origDraw = draw;
  window.draw = function(){
    origDraw();
    if(playing && !waveActive){
      const t = towerTypes[selectedTowerType];
      if(t){
        ctx.save();
        ctx.globalAlpha = 0.85;
        ctx.fillStyle = t.color;
        ctx.beginPath();
        ctx.arc(mouse.x, mouse.y, 14, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = '#0005';
        ctx.stroke();
        ctx.globalAlpha = 0.5;
        ctx.beginPath();
        ctx.arc(mouse.x, mouse.y, t.range, 0, Math.PI*2);
        ctx.stroke();
        ctx.restore();
      }
    }
  };
})();
console.log('Enhanced Tower Defense loaded. Controls: 1-6 select, left click place, right click upgrade, SPACE spawn waves.');
</script>
</body>
</html>
